<%- include("partiels/head",{pageTitle : "results" }) %>

  <link rel="stylesheet" href="/styles/index.css">
  <script src="/js/inputVerificator.js" defer></script>
  <script src="/js/result.js" defer></script>

  </head>

  <body>
    <%- include("partiels/navbar") %>

      <section class="form-result container">
        <img class="ooorganize" src="/svgs/ooorganize.svg" alt="">
        <form action="/validate" id="validateFormAjax" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label class="typemail" for="manualEmails">Saisissez un ou plusieurs e-mails manuellement <br>(un par ligne
              ou s√©par√©s par une virgule).</label>
            <div class="input-btn-submit-bl">
              <textarea name="manualEmails" id="manualEmails" rows="2"
                placeholder="example1@gmail.com , example2@yahoo.com"></textarea>
              <div class="btn-bl">
                <button id="validateBtn" type="submit">
                  <i class="bi bi-check-circle"></i><span>V√©rifier</span>
                </button>
              </div>
            </div>

            <% if (message) { %>
              <div id="formMessage" class="alert error fade-in">
                <%= message %>
              </div>
              <% } else { %>
                <div id="formMessage" class="alert hidden fade-in"></div>
                <% } %>
          </div>

          <div class="form-group input-file">
            <label for="emailFile" id="uploadLabel">
              <i class="bi bi-arrow-bar-up"></i>
              <span>Importer un fichier CSV </span>
            </label>
            ou
            <a href="#">Cr√©er mon fichier CSV</a>
            <input hidden type="file" name="emailFile" id="emailFile" accept=".csv">
          </div>
          <div class="upload-animation" id="uploadAnimation">
            <div class="circle-loader"></div>
            <div class="checkmark">‚úî</div>
          </div>

          <p id="fileNameDisplay" class="file-name-display"
            style="font-weight: 600; color: #00ba4b;font-style: italic;"></p>

          <p class="upload-message" id="uploadMessage"></p>

        </form>
      </section>

      <section class="tab-results">
        <div class="container">

          <div class="download-links">
            <h2>Validation Results</h2>

            <div>
              <% if (csvPath) { %>
                <a class="btn" href="<%= csvPath %>" download><i style="margin-right: 5px;" class="bi bi-download"></i>
                  T√©l√©charger tous les r√©sultats CSV</a>
                <% } %>
                  <% if (validCsvPath) { %>
                    <a class="btn valid" href="<%= validCsvPath %>" download> <i style="margin-right: 5px;"
                        class="bi bi-download"></i> T√©l√©charger les emails valides</a>
                    <% } %>
            </div>
          </div>

          <table id="resultsTable">
            <thead>
              <tr>
                <th>Email</th>
                <th>Format</th>
                <th>Type</th>
                <th>Serveur Status</th>
                <th>Email Status</th>
                <th>Score</th>
                <th>Substatus</th>
              </tr>
            </thead>
            <tbody>
              <% if (!results || results.length===0) { %>
                <tr>
                  <td colspan="7" class="empty-message"><i class="bi bi-box-seam " style="font-size: 24px; margin-left: 10px;"></i> Aucun email valid√© pour le moment.</td>
                </tr>
                <% } else { %>
                  <% results.forEach((r, index)=> { %>
                    <tr class="clickable-row" data-index="<%= index %>">
                      <td>
                        <%= r.email %> <i style="margin-left: 10px;">(cliquer pour plus de details)</i>
                      </td>
                      <td class="status <%= r.format %>">
                        <%= r.format %>
                      </td>
                      <td class="status <%= r.type %>">
                        <%= r.type %>
                      </td>
                      <td class="status <%= r.serverType %>">
                        <%= r.serverType %>
                      </td>
                      <td class="status <%= r.emailStatus %>">
                        <%= r.emailStatus %>
                      </td>
                      <td class="status <%= r.score > 50 ? 'goodScore':'badScore'   %>">
                        <%= r.score %>
                      </td>
                      <td class="status <%= r.subStatus %>">
                        <%= r.subStatus %>
                      </td>
                    </tr>
                    <tr class="dropdown-row" id="dropdown-<%= index %>">
                      <td colspan="7">
                        <div>
                          <div>
                            <div>
                              <i class="bi bi-shield-fill-exclamation"></i>
                              <i class="bi bi-shield-fill-x"></i> 
                              <i class="bi bi-shield-fill-check"></i>              
                            </div>
                            <div>
                              <p class="mail">
                                <%= r.email %>
                              </p>
                              <p>
                                <%= r.emailStatus==='valid' ? "cette adresse email est utilis√© pour recevoir des mails"
                                  :"cette adresse email n'est utiliser pour recevoir des mails" %>
                              </p>

                            </div>
                          </div>
                          <div class="details-container">
                            <!-- FORMAT -->
                            <div class="detail-item">
                              <p>Format :
                                <span class="status <%= r.format %>"><%= r.format %></span>
                              </p>
                              <p>
                                <% if (r.format === 'valid') { %>
                                  Cette adresse email a un format valide conforme aux standards (ex: nom@domaine.com).
                                <% } else if (r.format === 'invalid') { %>
                                  Le format de cette adresse email est invalide. Elle ne suit pas la structure correcte.
                                <% } else if (r.format === 'unknown') { %>
                                  Le format de cette adresse n'a pas pu √™tre d√©termin√©.
                                <% } else { %>
                                  Format non reconnu.
                                <% } %>
                              </p>
                            </div>
                          
                            <!-- TYPE -->
                            <div class="detail-item">
                              <p>Type :
                                <span class="status <%= r.type %>"><%= r.type %></span>
                              </p>
                              <p>
                                <% if (r.type === 'webmail') { %>
                                  Il s'agit d'une adresse de messagerie personnelle (ex: Gmail, Yahoo, Outlook...).
                                <% } else if (r.type === 'corporate') { %>
                                  C'est une adresse professionnelle associ√©e √† un nom de domaine d'entreprise.
                                <% } else if (r.type === 'disposable') { %>
                                  C'est une adresse jetable utilis√©e temporairement (souvent pour √©viter le spam).
                                <% } else if (r.type === 'role') { %>
                                  Cette adresse est g√©n√©rique (ex: info@, contact@, support@) et souvent partag√©e.
                                <% } else if (r.type === 'unknown') { %>
                                  Le type de cette adresse email n'a pas pu √™tre identifi√©.
                                <% } else { %>
                                  Type d'adresse non sp√©cifi√©.
                                <% } %>
                              </p>
                            </div>
                          
                            <!-- SERVER -->
                            <div class="detail-item">
                              <p>Serveur :
                                <span class="status <%= r.serverType %>"><%= r.serverType || 'inconnu' %></span>
                              </p>
                              <p>
                                <% if (r.serverType === 'gmail') { %>
                                  Serveur Gmail d√©tect√© ‚Äî fiable et souvent bien configur√©.
                                <% } else if (r.serverType === 'microsoft') { %>
                                  Serveur Microsoft (Outlook, Hotmail, Office 365).
                                <% } else if (r.serverType === 'yahoo') { %>
                                  Serveur Yahoo Mail d√©tect√©.
                                <% } else if (r.serverType === 'custom') { %>
                                  Serveur personnalis√© ‚Äî souvent utilis√© par les entreprises.
                                <% } else if (r.serverType === 'unknown' || !r.serverType) { %>
                                  Impossible d‚Äôidentifier le serveur de messagerie.
                                <% } else { %>
                                  Serveur non reconnu.
                                <% } %>
                              </p>
                            </div>
                          
                            <!-- EMAIL STATUS -->
                            <div class="detail-item">
                              <p>Statut :
                                <span class="status <%= r.emailStatus %>"><%= r.emailStatus %></span>
                              </p>
                              
                            </div>
                          
                            <!-- SCORE -->
                            <div class="detail-item">
                              <p>Score :
                                <span class="status <%= r.score > 70 ? 'goodScore' : r.score > 40 ? 'mediumScore' : 'badScore' %>">
                                  <%= r.score %>
                                </span>
                              </p>
                              <p>
                                <% if (r.score > 70) { %>
                                  Excellent score de fiabilit√© ‚Äî adresse tr√®s s√ªre.
                                <% } else if (r.score > 40) { %>
                                  Score moyen ‚Äî cette adresse peut √™tre risqu√©e.
                                <% } else { %>
                                  Faible score ‚Äî cette adresse semble invalide ou inactive.
                                <% } %>
                              </p>
                            </div>
                          
                            <!-- SUBSTATUS -->
                            <div class="detail-item">
                              <p>Sous-statut :
                                <span class="status <%= r.subStatus %>"><%= r.subStatus || 'aucun' %></span>
                              </p>
                              <p>
                                <% if (r.subStatus === 'mailbox_full') { %>
                                  La bo√Æte de r√©ception est pleine, les messages risquent d‚Äô√™tre rejet√©s.
                                <% } else if (r.subStatus === 'role_based') { %>
                                  Adresse partag√©e par plusieurs utilisateurs (souvent pour le support).
                                <% } else if (r.subStatus === 'disposable') { %>
                                  Adresse temporaire d√©tect√©e.
                                <% } else if (r.subStatus === 'unknown') { %>
                                  Le sous-statut n‚Äôa pas pu √™tre d√©termin√©.
                                <% } else { %>
                                  Aucun sous-statut particulier d√©tect√©.
                                <% } %>
                              </p>
                            </div>
                          </div>
                        </div>
                        üìß <b>Email :</b> <br>
                        ‚öôÔ∏è <b>Serveur :</b>
                        <%= r.serverType || 'Non sp√©cifi√©' %><br>
                          üîç <b>Statut :</b>
                          <%= r.emailStatus || 'Inconnu' %><br>
                            üí° <b>Score :</b>
                            <%= r.score || 'N/A' %><br>
                              üß© <b>Sous-statut :</b>
                              <%= r.subStatus || 'Aucun' %><br>
                                üïì <b>Date de v√©rification :</b>
                                <%= new Date().toLocaleString() %>
                      </td>
                    </tr>
                    <% }) %>
                      <% } %>
            </tbody>
          </table>

          <a class="btn back" href="/">Valider plus d'emails</a>
        </div>
      </section>

      <%- include("partiels/footer") %>